(function(e){"use strict";function b(){if(!(this instanceof b)){return new b}this.topics=[];this.oId=0}function w(e,t){this.oId=e;this.obj=t;this._pipeline_=[]}var t=function(e,t){return Object.prototype.toString.call(e).slice(8,-1)===t},n=function(e){return{obj:function(){return t(e,"Object")&&Object.keys(e).length},string:function(){return t(e,"String")&&e.length},number:function(){return e&&t(e,"Number")&&e!==Infinity&&e!==-Infinity},fun:function(){return t(e,"Function")},array:function(){return t(e,"Array")&&e.length}}},r=function(e,t){var n,r=false,i=function(){if(!r){n=arguments}r=true;if(!(this instanceof i)){return new i}this._constructor.apply(this,n)};i.prototype=t;for(var s in e){if(e.hasOwnProperty(s)){i.prototype[s]=e[s]}}if(!i.prototype._constructor){i.prototype._constructor=function(){}}return i},i=function(e){setTimeout(e,0)},s={subUsage:function(){return"USAGE [ topic:String, scope:Object ]"},pubUsage:function(){return"UASGE [ topic:String[, message1:Any[, message2:Any[, ..]]] ]"},unsubUsage:function(){return"USAGE [ topic:String, instance:Subscriber ]"},pubError:function(e,t){return'Failed to publish to obj on topic "'+e+'" ['+t.message+"]"},extendUsage:function(){return"argument to Bugle extend must be an object literal"}},o=function(e){return function(t,n){return e.reduce(function(e,t,r){return t.call(n?n:null,e)}.bind(this),t)}},u=function(e){return e.reduce(function(e,t){var r=n(t).array();return e.concat(r?u(t):t)}.bind(this),[])},a=function(e){return function(t){return t.reduce(function(t,n){return t.concat([e.call(this,n)])}.bind(this),[])}},f=function(e){return function(t){return t.reduce(function(t,n){return e.call(this,n)?t.concat([n]):t}.bind(this),[])}},l=function(e){var t=function(t){return!e.call(this,t)};return function(e){return f(t).call(this,e)}},c=function(e){var t=[a(e),a(u)];return function(e){return o(t)(e,this)}},h=function(e){return[u.call(this,e)]},p=function(e){return function(t){e.apply(this,[].concat(t))}},d=function(e,t,n){i(function(){try{n.digest(t)}catch(r){throw s.pubError(e,r)}}.bind(this))},v=function(e){if(n(e).string()){var t=Array.prototype.slice.call(arguments,1),r=d.bind(null,e,t);if(this.topics[e]){var i=this.topics[e];i.forEach(r)}}else{throw s.pubUsage()}},m=function(e,t){t=t?t:this;if(n(e).string()){if(!this.topics[e]){this.topics[e]=[]}var r=new w(++this.oId,t);this.topics[e].push(r);return r}else{throw s.subUsage()}},g=function(e,t){if(t&&n(t.oId).number()&&n(e).string()){var r=this.topics[e],o=t.oId,u=function(e,t){if(e.oId===o)r.splice(t,1)};if(r){i(function(){r.forEach(u)}.bind(this))}}else{throw s.unsubUsage()}},y=function(e){if(n(e).obj()){return r(e,this)}else{throw s.extendUsage()}};b.prototype={pub:v,sub:m,unsub:g,extend:y};w.prototype={map:function(e){this._pipeline_.push(a(e));return this},filter:function(e){this._pipeline_.push(f(e));return this},reject:function(e){this._pipeline_.push(l(e));return this},flatMap:function(e){this._pipeline_.push(c(e));return this},squash:function(){this._pipeline_.push(h);return this},receive:function(e){this._pipeline_.push(p(e))},digest:function(e){if(n(this._pipeline_).array()){o(this._pipeline_)(e,this.obj)}}};e["extend"]=function(e){return b().extend(e)}})(typeof module!=="undefined"&&module.exports?module.exports:window.Bugle={})